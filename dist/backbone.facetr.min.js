// Backbone.Facetr 0.1.0 
// Copyright (c)2012-2013 Arillo GmbH 
// Author Francesco Macri 
// Distributed under MIT license 
// https://github.com/arillo/Backbone.Facetr 
(function(e,t){if("object"==typeof exports){var r=require("underscore"),n=require("backbone");module.exports=t(r,n)}else"function"==typeof define&&define.amd?define(["underscore","backbone"],t):t(e,_,Backbone)})(this,function(e,t,r,n){"use strict";r.Facetr=function(e,t){return e instanceof r.Collection?a(e,t):o(e)},r.Facetr.VERSION="0.0.1";var i={},o=function(e){var t=i[e];return t?t:n},a=function(e,t){var r=e.facetrid||t||"fctr"+(new Date).getTime()+Math.floor(99*Math.random()+1),n=o(r);return n?n:(e.facetrid=r,i[r]=new s(e))},c=function(e,t){var i,o=t.split("."),a=o.length,c=0;do i=i instanceof Array?i:i&&(i.get&&i.get(o[c])||i[o[c]])||e&&e instanceof r.Model&&e.get(o[c])||n,c+=1;while(a>c);return i},u=function(e,n,i,o){t.extend(this,r.Events);var a=this,u=e,s=e,f="value",l="asc",v=[],h=[],d=[],g={},p=o,O="or",y=!1,m={},C=function(e,n,i){var o=n||"undefined",a=!1;if(o instanceof Object){var c=u.split(".")[1];o=c&&(o instanceof r.Model&&o.get(c)||o[c])||"undefined",a=!0}var s=t.find(e,function(e){return e.value===o});if(s)s.count=s.count+1,s.activeCount=s.activeCount+1;else{var f=t.sortedIndex(t.pluck(v,"value"),o);v.splice(f,0,{value:o,count:1,activeCount:1,active:!1}),g[o]=[]}a&&g[o].push(i)},x=function(e){var r=c(e,u);if(r)if(r instanceof Array)t.each(r,function(t){C(v,t,e.cid),g[t]&&g[t].push(e.cid)});else{if("object"==typeof r)throw a.remove(),Error("Model property can only be a value (string,number) or Array of values, not an object");C(v,r),g[r].push(e.cid)}},w=function(e){t(e).each(function(e){x(e)})},b=function(){v.sort(function(e,t){return"value"===f?"asc"===l?(e.value>t.value)-(e.value<t.value):(e.value<t.value)-(e.value>t.value):"activeCount"===f?"asc"===l?e.activeCount<t.activeCount?-1:e.activeCount>t.activeCount?1:(e.value>t.value)-(e.value<t.value):e.activeCount<t.activeCount?1:e.activeCount>t.activeCount?-1:(e.value<t.value)-(e.value>t.value):"asc"===l?e.count<t.count?-1:e.count>t.count?1:(e.value>t.value)-(e.value<t.value):e.count<t.count?1:e.count>t.count?-1:(e.value<t.value)-(e.value>t.value)})},N=function(){return 0!==h.length},M=function(e){for(var r=0,n=v.length;n>r;r+=1){var i=t.intersection(g[v[r].value],e).length;v[r].activeCount=0!==i?i:0}},S=function(e){var t=h.splice(0,h.length);v.splice(0,v.length),d.splice(0,d.length),g={},w(e);for(var r=0,n=t.length;n>r;r+=1)a.value(t[r])},P=function(e){x(e);for(var t=0,r=h.length;r>t;t+=1)a.value(h[t])},J=function(e){var r,n,i=e.cid,o=(e.toJSON(),function(e){for(r=v.length-1;-1!==r;){var n=v[r];if(n.value===e){if(n.count-=1,n.activeCount-=1,0===n.count){v.splice(r,1);var i=t.indexOf(h,n.value);-1!==i&&(h.splice(i,1),y=N())}break}r-=1}});for(var a in g)g.hasOwnProperty(a)&&(r=t.indexOf(g[a],i),-1!==r&&g[a].splice(r,1));if(n=c(e,u))if(n instanceof Array)for(var s=0,f=n.length;f>s;s++)o(n[s]);else o(n);r=t.indexOf(d,i),-1!==r&&d.splice(r,1)},V=function(e){var t,n;c(new r.Model(e.changedAttributes()),u)&&(t=new r.Model(e.previousAttributes()),n=c(t,u),t.cid=e.cid,J(t),P(e))},k=function(){this.and=function(e){return O="and",a.value(e),this},this.or=function(e){return O="or",a.value(e),this}};this.label=function(e){return s=e,this},this.asc=function(){return l="asc",b(),this},this.desc=function(){return l="desc",b(),this},this.sortByValue=function(){return f="value",b(),this},this.sortByCount=function(){return f="count",b(),this},this.sortByActiveCount=function(){return f="activeCount",b(),this},this.toJSON=function(){return{data:{name:u,label:s,extOperator:p,intOperator:O,sort:{by:f,direction:l},selected:y,customData:m},values:v}},this.remove=function(){i.off("resetCollection",M),i.off("resetOrigCollection",S),i.off("addModel",P),i.off("removeModel",J),i.off("changeModel",V),i.trigger("removeFacet",u)},this.value=function(e,r){r&&(O=r);var n,o=t.chain(v).pluck("value").indexOf(e).value();if(-1!==o)return n=v[o],n.active||(n.active=!0,h.push(n.value)),d="or"===O||0===d.length?t.union(d,g[e]):t.intersection(d,g[e]),y=N(),i.trigger("value",u,e,d),new k(this,O);throw Error('Value "'+e+'" does not exist for facet '+u)},this.removeValue=function(e){var r,n,o,a=t.chain(v).pluck("value").indexOf(e).value();if(-1!==a){if(r=v[a],r.active){if(r.active=!1,h.splice(t.indexOf(h,r.value),1),o=t.filter(g[e],function(e){for(var r in g)if(g.hasOwnProperty(r)&&-1!==t.indexOf(h,r)&&-1!==t.indexOf(g[r],e))return!1;return!0}),d=t.difference(d,o),"and"===O){n=[];for(var c=0,s=h.length;s>c;c+=1)n=0===n.length?t.union(n,g[h[c]]):t.intersection(n,g[h[c]]);d=t.union(d,n)}y=N(),i.trigger("removeValue",u,e,d)}return this}throw Error('Value "'+e+'" does not exist for facet '+u)},this.clear=function(){for(;h.length>0;)this.removeValue(h[0])},this.customData=function(e,t){return m[e]=t,this},w(n),i.on("resetCollection",M),i.on("resetOrigCollection",S),i.on("addModel",P),i.on("removeModel",J),i.on("changeModel",V)},s=function(e){t.extend(this,r.Events);var o,a,s,f,l=this,v={},h={},d={},g=t.extend({},r.Events),p="asc",O=function(){for(var t in h)h.hasOwnProperty(t)&&delete h[t];e.each(function(e){var t=e.clone();t.cid=e.cid,h[e.cid]=t})},y=function(e){delete v[e]},m=function(e,t){var r=v[e];if(r&&r.operator===t)return r;var n=new u(e,h,g,t);return d[e]=[],{facet:n,operator:t}},C=function(e,t){d[e]=t,b()},x=function(e,t,r){C(e,r),this.trigger("filter",e,t)},w=function(e,t,r){C(e,r),this.trigger("unfilter",e,t)},b=function(r){var n=[],i=[];for(var o in h)h.hasOwnProperty(o)&&n.push(o);for(var u in d)d.hasOwnProperty(u)&&v[u].facet.toJSON().data.selected&&(n="or"===v[u].operator?t.union(n,d[u]):t.intersection(n,d[u]));a&&s&&(n=t.filter(n,function(e){var t=c(h[e],s);return a.test(t)})),n.sort();for(var f=0,p=n.length;p>f;f+=1)i.push(h[n[f]]);e.reset(i,{silent:!0}),g.trigger("resetCollection",n),r||l.trigger("reset",i)},N=function(){O(),g.trigger("resetOrigCollection",h)},M=function(e){var t=e.clone();t.cid=e.cid,h[e.cid]=t,g.trigger("addModel",e),l.trigger("add",e)},S=function(e){delete h[e.cid],g.trigger("removeModel",e);var r=t.any(v,function(e){return e.facet.toJSON().data.selected});r||b(),l.trigger("remove",e)},P=function(e){delete h[e.cid];var r=e.clone();r.cid=e.cid,h[e.cid]=r,g.trigger("changeModel",e);var n=t.any(v,function(e){return e.facet.toJSON().data.selected});n||b(),l.trigger("change",e)},J=function(t){e.comparator=function(e,t){var r,n,i=c(e,o),a=c(t,o);if(r=parseInt(i,10),n=parseInt(a,10),(isNaN(r)||isNaN(n))&&(r=i,n=a),r=Date.parse(i),n=Date.parse(a),(isNaN(r)||isNaN(n))&&(r=i,n=a),"asc"===p){if(r&&n)return(r>n)-(n>r);if(r)return 1;if(n)return-1}else{if(r&&n)return(n>r)-(r>n);if(r)return-1;if(n)return 1}},e.sort(),t||l.trigger("sort",o,p)};this.facet=function(e,t){var r=!t||"and"!==t&&"or"!==t?"and":t;return v[e]=m(e,r),this.trigger("facet",e),v[e].facet},this.toJSON=function(){var e,r,n,i,o=[],a=[];for(e in v)v.hasOwnProperty(e)&&(r=v[e],n=r.facet.toJSON(),n.data.operator=r.operator,f&&f instanceof Array?(i=t.indexOf(f,n.data.name),-1!==i?a[i]=n:o.push(n)):o.push(n));return a.concat(o)},this.clear=function(t){var r;for(r in v)v.hasOwnProperty(r)&&(v[r].facet.remove(),delete v[r]);var n=[];for(r in h)h.hasOwnProperty(r)&&n.push(h[r]);return e.reset(n,{silent:!0}),t||this.trigger("clear",n),d={},this},this.clearValues=function(t){var r;for(r in v)v.hasOwnProperty(r)&&v[r].facet.clear();var n=[];for(r in h)h.hasOwnProperty(r)&&n.push(h[r]);return e.reset(n,{silent:!0}),t||this.trigger("clearValues",n),d={},this},this.remove=function(){var t=e.facetrid;this.clear(!0),e.off("reset",N),e.off("add",M),e.off("remove",S),e.off("change",P),delete e.facetrid,delete i[t]},this.facetsOrder=function(e){return f=e,this.trigger("facetsOrderChange",e),this},this.sortBy=function(e,t){return o=e,J(t),this},this.asc=function(e){return p="asc",J(e),this},this.desc=function(e){return p="desc",J(e),this},this.filterBy=function(e,t,r){return a=t?RegExp(t,"i"):n,s=e,b(r),this},this.collection=function(){return e},this.origLength=function(){return t.size(h)},this.initFromSettingsJSON=function(t){for(var n=r.Facetr,i=t.facets,o=t.sort,a=t.search,c=0,u=i.length;u>c;c+=1){var s,f=i[c],l=f.attr,v=f.eop,h=f.iop,d=f.vals;if(s=n(e).facet(l,v))for(var g=0,p=d.length;p>g;g+=1)s.value(d[g],h)}if(o){var O=o.by,y=o.dir;O&&n(e).sortBy(O,!0),y&&n(e)[y](!0)}if(a){var m=a.attr,C=a.regex;m&&C&&n(e).filterBy(m,C,!0)}return this.trigger("reset"),this},this.settingsJSON=function(){var e={};if(o&&p&&(e.sort={by:o,dir:p}),s&&a&&(e.search={attr:s,regex:(""+a).replace("/i","").replace("/","")}),0!==t.size(v)){e.facets=[];for(var r in v)if(v.hasOwnProperty(r)){for(var n=v[r].facet.toJSON(),i=(v[r].operator,t.pluck(n.values,"active")),c=[],u=0,f=i.length;f>u;u+=1)i[u]&&c.push(n.values[u].value);e.facets.push({attr:n.data.name,eop:n.data.extOperator,iop:n.data.intOperator,vals:c})}}return e},O(),g.on("removeFacet",y,this),g.on("value",x,this),g.on("removeValue clear",w,this),e.on("reset",N),e.on("add",M),e.on("remove",S),e.on("change",P)};return e.Facetr=r.Facetr});