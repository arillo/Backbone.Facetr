// backbone.facetr 0.2.4 
// Copyright (c)2012-2013 Arillo GmbH 
// Author Francesco Macri 
// Distributed under MIT license 
// https://github.com/arillo/Backbone.Facetr 
(function(e,t){if("object"==typeof exports){var r=require("underscore"),n=require("backbone");module.exports=t(r,n)}else"function"==typeof define&&define.amd?define(["underscore","backbone"],t):e.Facetr=t(_,Backbone)})(this,function(e,t,r){"use strict";t.Facetr=function(e,r){return e instanceof t.Collection?o(e,r):i(e)},t.Facetr.VERSION="0.2.4";var n={},i=function(e){var t=n[e];return t?t:r},o=function(e,t){var r=e.facetrid||t||"fctr"+(new Date).getTime()+Math.floor(99*Math.random()+1),o=i(r);return o?o:(e.facetrid=r,n[r]=new u(e))},a=function(e,n){var i,o=n.split("."),a=o.length,c=0;for(i=e.get(o[c]),c=1;a>c;c+=1){if(i===r)return i;if(i instanceof Array)return i;i=i instanceof t.Model?i.get(o[c]):"[object Object]"===Object.prototype.toString.call(i)?i[o[c]]:i}return i},c=function(n,i,o,c){e.extend(this,t.Events);var u=this,s=n,f=n,l="value",v="asc",h=[],d=[],g=[],p={},O=c,y="or",m=!1,b={},C=function(n,i,o){var a=i!==r&&null!==i?i:"undefined",c=!1;if("[object Object]"===Object.prototype.toString.call(a)){var u=s.split(".")[1];a=u&&(a instanceof t.Model&&a.get(u)||a[u])||"undefined",c=!0}var f=e.find(n,function(e){return e.value===a});if(f)f.count=f.count+1,f.activeCount=f.activeCount+1;else{var l=e.sortedIndex(e.pluck(h,"value"),a);h.splice(l,0,{value:a,count:1,activeCount:1,active:!1}),p[a]=[]}return c&&p[a].push(o),a},w=function(t){var r,n=a(t,s);if(n instanceof Array)0===n.length?(r=C(h,"undefined",t.cid),p[r].push(t.cid)):e.each(n,function(e){r=C(h,e,t.cid),p[r]&&p[r].push(t.cid)});else{if("[object Object]"===Object.prototype.toString.call(n))throw u.remove(),Error("Model property can only be a value (string,number,boolean) or Array of values, not an object");r=C(h,n),p[r].push(t.cid)}},N=function(t){e(t).each(function(e){w(e)})},x=function(){h.sort(function(e,t){return"value"===l?"asc"===v?(e.value>t.value)-(e.value<t.value):(e.value<t.value)-(e.value>t.value):"activeCount"===l?"asc"===v?e.activeCount<t.activeCount?-1:e.activeCount>t.activeCount?1:(e.value>t.value)-(e.value<t.value):e.activeCount<t.activeCount?1:e.activeCount>t.activeCount?-1:(e.value<t.value)-(e.value>t.value):"asc"===v?e.count<t.count?-1:e.count>t.count?1:(e.value>t.value)-(e.value<t.value):e.count<t.count?1:e.count>t.count?-1:(e.value<t.value)-(e.value>t.value)})},M=function(){return 0!==d.length},S=function(t){for(var r=0,n=h.length;n>r;r+=1){var i=e.intersection(p[h[r].value],t).length;h[r].activeCount=0!==i?i:0}},F=function(e){var t=d.splice(0,d.length);h.splice(0,h.length),g.splice(0,g.length),p={},N(e);for(var r=0,n=t.length;n>r;r+=1)u.value(t[r])},P=function(e){w(e);for(var t=0,r=d.length;r>t;t+=1)u.value(d[t])},j=function(t){var r,n,i=t.cid,o=(t.toJSON(),function(t){for(r=h.length-1;-1!==r;){var n=h[r];if(n.value===t){if(n.count-=1,n.activeCount-=1,0===n.count){h.splice(r,1);var i=e.indexOf(d,n.value);-1!==i&&(d.splice(i,1),m=M())}break}r-=1}});for(var c in p)p.hasOwnProperty(c)&&(r=e.indexOf(p[c],i),-1!==r&&p[c].splice(r,1));if(n=a(t,s))if(n instanceof Array)for(var u=0,f=n.length;f>u;u++)o(n[u]);else o(n);r=e.indexOf(g,i),-1!==r&&g.splice(r,1)},k=function(e){var r,n;a(new t.Model(e.changedAttributes()),s)&&(r=new t.Model(e.previousAttributes()),n=a(r,s),r.cid=e.cid,j(r),P(e))},J=function(){this.and=function(e){return y="and",u.value(e),this},this.or=function(e){return y="or",u.value(e),this}};this.label=function(e){return f=e,this},this.asc=function(){return v="asc",x(),this},this.desc=function(){return v="desc",x(),this},this.sortByValue=function(){return l="value",x(),this},this.sortByCount=function(){return l="count",x(),this},this.sortByActiveCount=function(){return l="activeCount",x(),this},this.toJSON=function(){return{data:{name:s,label:f,extOperator:O,intOperator:y,sort:{by:l,direction:v},selected:m,customData:b},values:h}},this.remove=function(){o.off("resetCollection",S),o.off("resetOrigCollection",F),o.off("addModel",P),o.off("removeModel",j),o.off("changeModel",k),o.trigger("removeFacet",s)},this.value=function(t,n){n&&(y=n);var i,a=e.chain(h).pluck("value").indexOf(t).value();return-1!==a?(i=h[a],i.active||(i.active=!0,d.push(i.value)),g="or"===y||0===g.length?e.union(g,p[t]):e.intersection(g,p[t]),m=M(),o.trigger("value",s,t,g),new J(this,y)):r},this.removeValue=function(t){var r,n,i,a=e.chain(h).pluck("value").indexOf(t).value();if(-1!==a){if(r=h[a],r.active){if(r.active=!1,d.splice(e.indexOf(d,r.value),1),i=e.filter(p[t],function(t){for(var r in p)if(p.hasOwnProperty(r)&&-1!==e.indexOf(d,r)&&-1!==e.indexOf(p[r],t))return!1;return!0}),g=e.difference(g,i),"and"===y){n=[];for(var c=0,u=d.length;u>c;c+=1)n=0===n.length?e.union(n,p[d[c]]):e.intersection(n,p[d[c]]);g=e.union(g,n)}m=M(),o.trigger("removeValue",s,t,g)}return this}throw Error('Value "'+t+'" does not exist for facet '+s)},this.clear=function(){for(;d.length>0;)this.removeValue(d[0])},this.customData=function(e,t){return t!==r?(b[e]=t,this):b[e]},this.isSelected=function(){return m},N(i),o.on("resetCollection",S),o.on("resetCollection",x),o.on("resetOrigCollection",F),o.on("addModel",P),o.on("removeModel",j),o.on("changeModel",k)},u=function(r){e.extend(this,t.Events);var i,o,u=this,s={},f={},l={},v=e.extend({},t.Events),h={},d="asc",g=!1,p=function(){for(var e in f)f.hasOwnProperty(e)&&delete f[e];r.each(function(e){var t=e.clone();t.cid=e.cid,f[e.cid]=t})},O=function(e){delete s[e]},y=function(e,t){var r=s[e];if(r&&r.operator===t)return r;var n=new c(e,f,v,t);return l[e]=[],{facet:n,operator:t}},m=function(e,t){l[e]=t,w()},b=function(e,t,r){m(e,r),this.trigger("filter",e,t)},C=function(e,t,r){m(e,r),this.trigger("unfilter",e,t)},w=function(t){var n,i,o,a,c=[],d=[];for(n in f)f.hasOwnProperty(n)&&c.push(n);for(i in l)l.hasOwnProperty(i)&&s[i].facet.toJSON().data.selected&&(c="or"===s[i].operator?e.union(c,l[i]):e.intersection(c,l[i]));a=function(e){return p(f[e])};for(o in h)if(h.hasOwnProperty(o)){var p=h[o];p instanceof Function&&(c=e.filter(c,a))}c.sort();for(var O=0,y=c.length;y>O;O+=1)d.push(f[c[O]]);g=!0,r.reset(d),g=!1,v.trigger("resetCollection",c),t||u.trigger("reset",d)},N=function(){g||(p(),v.trigger("resetOrigCollection",f))},x=function(e){var t=e.clone();t.cid=e.cid,f[e.cid]=t,v.trigger("addModel",e),u.trigger("add",e)},M=function(t){delete f[t.cid],v.trigger("removeModel",t);var r=e.any(s,function(e){return e.facet.toJSON().data.selected});r||w(),u.trigger("remove",t)},S=function(t){delete f[t.cid];var r=t.clone();r.cid=t.cid,f[t.cid]=r,v.trigger("changeModel",t);var n=e.any(s,function(e){return e.facet.toJSON().data.selected});n||w(),u.trigger("change",t)},F=function(e){r.comparator=function(e,t){var r,n,o=a(e,i),c=a(t,i);if(isNaN(o)||isNaN(c)?(r=Date.parse(o),n=Date.parse(c),(isNaN(r)||isNaN(n))&&(r=o,n=c)):(r=parseFloat(o,10),n=parseFloat(c,10)),"asc"===d){if(r&&n)return(r>n)-(n>r);if(r)return 1;if(n)return-1}else{if(r&&n)return(n>r)-(r>n);if(r)return-1;if(n)return 1}},r.sort(),e||u.trigger("sort",i,d)};this.facet=function(e,t){var r=!t||"and"!==t&&"or"!==t?"and":t;return s[e]=y(e,r),this.trigger("facet",e),s[e].facet},this.toJSON=function(){var t,r,n,i,a=[],c=[];for(t in s)s.hasOwnProperty(t)&&(r=s[t],n=r.facet.toJSON(),n.data.operator=r.operator,o&&o instanceof Array?(i=e.indexOf(o,n.data.name),-1!==i?c[i]=n:a.push(n)):a.push(n));return c.concat(a)},this.clear=function(e){var t;for(t in s)s.hasOwnProperty(t)&&(s[t].facet.remove(),delete s[t]);var n=[];for(t in f)f.hasOwnProperty(t)&&n.push(f[t]);return r.reset(n),l={},e||this.trigger("clear",n),this},this.clearValues=function(e){var t;for(t in s)s.hasOwnProperty(t)&&s[t].facet.clear();var n=[];for(t in f)f.hasOwnProperty(t)&&n.push(f[t]);return r.reset(n),l={},e||this.trigger("clearValues",n),this},this.remove=function(){var e=r.facetrid;this.clear(!0),r.off("reset",N),r.off("add",x),r.off("remove",M),r.off("change",S),delete r.facetrid,delete n[e]},this.facetsOrder=function(e){return o=e,this.trigger("facetsOrderChange",e),this},this.sortBy=function(e,t){return i=e,F(t),this},this.asc=function(e){return d="asc",F(e),this},this.desc=function(e){return d="desc",F(e),this},this.addFilter=function(e,t,r){return t&&e&&(h[e]=t,w(r)),this},this.removeFilter=function(e,t){return e&&(delete h[e],w(t)),this},this.clearFilters=function(e){for(var t in h)h.hasOwnProperty(t)&&delete h[t];return w(e),this},this.collection=function(){return r},this.origLength=function(){return e.size(f)},this.initFromSettingsJSON=function(e){var n=t.Facetr,i=e.facets,o=e.sort;e.search,this.clear(!0),this.clearFilters(!0);for(var a=0,c=i.length;c>a;a+=1){var u,s=i[a],f=s.attr,l=s.eop,v=s.iop,h=s.sort,d=s.cust,g=s.vals;switch(u=n(r).facet(f,l),h.by){case"count":u.sortByCount();break;case"activeCount":u.sortByActiveCount();break;default:u.sortByValue()}if(u[h.direction](),d)for(var p in d)d.hasOwnProperty(p)&&u.customData(p,d[p]);for(var O=0,y=g.length;y>O;O+=1)u.value(g[O],v)}if(o){var m=o.by,b=o.dir;m&&n(r).sortBy(m,!0),b&&n(r)[b](!0)}return this.trigger("reset"),this},this.settingsJSON=function(){var t={};if(i&&d&&(t.sort={by:i,dir:d}),0!==e.size(s)){t.facets=[];for(var r in s)if(s.hasOwnProperty(r)){for(var n=s[r].facet.toJSON(),o=e.pluck(n.values,"active"),a=[],c=0,u=o.length;u>c;c+=1)o[c]&&a.push(n.values[c].value);t.facets.push({attr:n.data.name,eop:n.data.extOperator,iop:n.data.intOperator,sort:n.data.sort,cust:n.data.customData,vals:a})}}return t},p(),v.on("removeFacet",O,this),v.on("value",b,this),v.on("removeValue clear",C,this),r.on("reset",N),r.on("add",x),r.on("remove",M),r.on("change",S)};return t.Facetr});