// backbone.facetr 0.2.6 
// Copyright (c)2012-2013 Arillo GmbH 
// Author Francesco Macri 
// Distributed under MIT license 
// https://github.com/arillo/Backbone.Facetr 
(function(t,e){if("object"==typeof exports){var n=require("underscore"),r=require("backbone");module.exports=e(n,r)}else"function"==typeof define&&define.amd?define(["underscore","backbone"],e):t.Facetr=e(_,Backbone)})(this,function(t,e,n){"use strict";e.Facetr=function(t,n){return t instanceof e.Collection?o(t,n):i(t)},e.Facetr.VERSION="0.2.6";var r={},i=function(t){var e=r[t];return e?e:n},o=function(t,e){var n=t.facetrid||e||"fctr"+(new Date).getTime()+Math.floor(99*Math.random()+1),o=i(n);return o?o:(t.facetrid=n,r[n]=new u(t))},a=function(t,r){var i,o=r.split("."),a=o.length,c=0;for(i=t.get(o[c]),c=1;a>c;c+=1){if(i===n)return i;if(i instanceof Array)return i;i=i instanceof e.Model?i.get(o[c]):"[object Object]"===Object.prototype.toString.call(i)?i[o[c]]:i}return i},c=function(r,i,o,c){t.extend(this,e.Events);var u=this,s=r,f=r,l="value",v="asc",h=[],d=[],g=[],p={},O=c,y="or",m=!1,b={},C=function(r,i,o){var a=i!==n&&null!==i?i:"undefined",c=!1;if("[object Object]"===Object.prototype.toString.call(a)){var u=s.split(".")[1];a=u&&(a instanceof e.Model&&a.get(u)||a[u])||"undefined",c=!0}var f=t.find(r,function(t){return t.value===a});if(f)f.count=f.count+1,f.activeCount=f.activeCount+1;else{var l=t.sortedIndex(t.pluck(h,"value"),a);h.splice(l,0,{value:a,count:1,activeCount:1,active:!1}),p[a]=[]}return c&&p[a].push(o),a},w=function(e){var n,r=a(e,s);if(r instanceof Array)0===r.length?(n=C(h,"undefined",e.cid),p[n].push(e.cid)):t.each(r,function(t){n=C(h,t,e.cid),p[n]&&p[n].push(e.cid)});else{if("[object Object]"===Object.prototype.toString.call(r))throw u.remove(),Error("Model property can only be a value (string,number,boolean) or Array of values, not an object");n=C(h,r),p[n].push(e.cid)}},N=function(e){t(e).each(function(t){w(t)})},x=function(){h.sort(function(t,e){return"value"===l?"asc"===v?(t.value>e.value)-(t.value<e.value):(t.value<e.value)-(t.value>e.value):"activeCount"===l?"asc"===v?t.activeCount<e.activeCount?-1:t.activeCount>e.activeCount?1:(t.value>e.value)-(t.value<e.value):t.activeCount<e.activeCount?1:t.activeCount>e.activeCount?-1:(t.value<e.value)-(t.value>e.value):"asc"===v?t.count<e.count?-1:t.count>e.count?1:(t.value>e.value)-(t.value<e.value):t.count<e.count?1:t.count>e.count?-1:(t.value<e.value)-(t.value>e.value)})},S=function(){return 0!==d.length},M=function(e){for(var n=0,r=h.length;r>n;n+=1){var i=t.intersection(p[h[n].value],e).length;h[n].activeCount=0!==i?i:0}},F=function(t){var e=d.splice(0,d.length);h.splice(0,h.length),g.splice(0,g.length),p={},N(t);for(var n=0,r=e.length;r>n;n+=1)u.value(e[n])},P=function(t){w(t);for(var e=0,n=d.length;n>e;e+=1)u.value(d[e])},j=function(e){var n,r,i=e.cid,o=(e.toJSON(),function(e){for(n=h.length-1;-1!==n;){var r=h[n];if(r.value===e){if(r.count-=1,r.activeCount-=1,0===r.count){h.splice(n,1);var i=t.indexOf(d,r.value);-1!==i&&(d.splice(i,1),m=S())}break}n-=1}});for(var c in p)p.hasOwnProperty(c)&&(n=t.indexOf(p[c],i),-1!==n&&p[c].splice(n,1));if(r=a(e,s))if(r instanceof Array)for(var u=0,f=r.length;f>u;u++)o(r[u]);else o(r);n=t.indexOf(g,i),-1!==n&&g.splice(n,1)},k=function(t){var n,r;a(new e.Model(t.changedAttributes()),s)&&(n=new e.Model(t.previousAttributes()),r=a(n,s),n.cid=t.cid,j(n),P(t))},J=function(){this.and=function(t,e){return y="and",u.value(t,e),this},this.or=function(t,e){return y="or",u.value(t,e),this}};this.label=function(t){return f=t,this},this.asc=function(){return v="asc",x(),this},this.desc=function(){return v="desc",x(),this},this.sortByValue=function(){return l="value",x(),this},this.sortByCount=function(){return l="count",x(),this},this.sortByActiveCount=function(){return l="activeCount",x(),this},this.toJSON=function(){return{data:{name:s,label:f,extOperator:O,intOperator:y,sort:{by:l,direction:v},selected:m,customData:b},values:h}},this.remove=function(){o.off("resetCollection",M),o.off("resetOrigCollection",F),o.off("addModel",P),o.off("removeModel",j),o.off("changeModel",k),o.trigger("removeFacet",s)},this.value=function(e,r,i){r&&(y=r);var a,c=t.chain(h).pluck("value").indexOf(e).value();return-1!==c?(a=h[c],a.active||(a.active=!0,d.push(a.value)),g="or"===y||0===g.length?t.union(g,p[e]):t.intersection(g,p[e]),m=S(),o.trigger("value",s,e,g,i),new J(this,y)):n},this.removeValue=function(e,n){var r,i,a,c=t.chain(h).pluck("value").indexOf(e).value();if(-1!==c){if(r=h[c],r.active){if(r.active=!1,d.splice(t.indexOf(d,r.value),1),a=t.filter(p[e],function(e){for(var n in p)if(p.hasOwnProperty(n)&&-1!==t.indexOf(d,n)&&-1!==t.indexOf(p[n],e))return!1;return!0}),g=t.difference(g,a),"and"===y){i=[];for(var u=0,f=d.length;f>u;u+=1)i=0===i.length?t.union(i,p[d[u]]):t.intersection(i,p[d[u]]);g=t.union(g,i)}m=S(),o.trigger("removeValue",s,e,g,n)}return this}throw Error('Value "'+e+'" does not exist for facet '+s)},this.clear=function(){for(;d.length>0;)this.removeValue(d[0],!0)},this.customData=function(t,e){return e!==n?(b[t]=e,this):b[t]},this.isSelected=function(){return m},N(i),o.on("resetCollection",M),o.on("resetCollection",x),o.on("resetOrigCollection",F),o.on("addModel",P),o.on("removeModel",j),o.on("changeModel",k)},u=function(n){t.extend(this,e.Events);var i,o,u=this,s={},f={},l={},v=t.extend({},e.Events),h={},d="asc",g=!1,p=function(){for(var t in f)f.hasOwnProperty(t)&&delete f[t];n.each(function(t){var e=t.clone();e.cid=t.cid,f[t.cid]=e})},O=function(t){delete s[t]},y=function(t,e){var n=s[t];if(n&&n.operator===e)return n;var r=new c(t,f,v,e);return l[t]=[],{facet:r,operator:e}},m=function(t,e){l[t]=e,w()},b=function(t,e,n,r){m(t,n),r!==!0&&this.trigger("filter",t,e)},C=function(t,e,n,r){m(t,n),r!==!0&&this.trigger("unfilter",t,e)},w=function(){var e,r,i,o,a=[],c=[];for(e in f)f.hasOwnProperty(e)&&a.push(e);for(r in l)l.hasOwnProperty(r)&&s[r].facet.toJSON().data.selected&&(a="or"===s[r].operator?t.union(a,l[r]):t.intersection(a,l[r]));o=function(t){return u(f[t])};for(i in h)if(h.hasOwnProperty(i)){var u=h[i];u instanceof Function&&(a=t.filter(a,o))}a.sort();for(var d=0,p=a.length;p>d;d+=1)c.push(f[a[d]]);g=!0,n.reset(c),g=!1,v.trigger("resetCollection",a)},N=function(){g||(p(),v.trigger("resetOrigCollection",f))},x=function(t){var e=t.clone();e.cid=t.cid,f[t.cid]=e,v.trigger("addModel",t)},S=function(e){delete f[e.cid],v.trigger("removeModel",e);var n=t.any(s,function(t){return t.facet.toJSON().data.selected});n||w()},M=function(e){delete f[e.cid];var n=e.clone();n.cid=e.cid,f[e.cid]=n,v.trigger("changeModel",e);var r=t.any(s,function(t){return t.facet.toJSON().data.selected});r||w()},F=function(t){n.comparator=function(t,e){var n,r,o=a(t,i),c=a(e,i);if(isNaN(o)||isNaN(c)?(n=Date.parse(o),r=Date.parse(c),(isNaN(n)||isNaN(r))&&(n=o,r=c)):(n=parseFloat(o,10),r=parseFloat(c,10)),"asc"===d){if(n&&r)return(n>r)-(r>n);if(n)return 1;if(r)return-1}else{if(n&&r)return(r>n)-(n>r);if(n)return-1;if(r)return 1}},n.sort(),t!==!0&&u.trigger("sort",i,d)};this.facet=function(t,e,n){var r=!e||"and"!==e&&"or"!==e?"and":e;return s[t]=y(t,r),n!==!0&&this.trigger("facet",t),s[t].facet},this.toJSON=function(){var e,n,r,i,a=[],c=[];for(e in s)s.hasOwnProperty(e)&&(n=s[e],r=n.facet.toJSON(),r.data.operator=n.operator,o&&o instanceof Array?(i=t.indexOf(o,r.data.name),-1!==i?c[i]=r:a.push(r)):a.push(r));return c.concat(a)},this.clear=function(t){var e;for(e in s)s.hasOwnProperty(e)&&(s[e].facet.remove(),delete s[e]);var r=[];for(e in f)f.hasOwnProperty(e)&&r.push(f[e]);return n.reset(r),l={},t!==!0&&this.trigger("clear"),this},this.clearValues=function(t){var e;for(e in s)s.hasOwnProperty(e)&&s[e].facet.clear();var r=[];for(e in f)f.hasOwnProperty(e)&&r.push(f[e]);return n.reset(r),l={},t!==!0&&this.trigger("clearValues"),this},this.remove=function(){var t=n.facetrid;this.clear(!0),n.off("reset",N),n.off("add",x),n.off("remove",S),n.off("change",M),delete n.facetrid,delete r[t]},this.facetsOrder=function(t,e){return o=t,e!==!0&&this.trigger("facetsOrderChange",t),this},this.sortBy=function(t,e){return i=t,F(e),this},this.asc=function(t){return d="asc",F(t),this},this.desc=function(t){return d="desc",F(t),this},this.addFilter=function(t,e,n){return e&&t&&(h[t]=e,w(n)),this},this.removeFilter=function(t,e){return t&&(delete h[t],w(e)),this},this.clearFilters=function(t){for(var e in h)h.hasOwnProperty(e)&&delete h[e];return w(t),this},this.collection=function(){return n},this.origLength=function(){return t.size(f)},this.facets=function(){return t.pluck(s,"facet")},this.initFromSettingsJSON=function(t){var r,i,o,a,c,u,s,f,l,v,h,d,g,p,O,y,m,b;for(i=e.Facetr,r=i(n),o=t.facets,a=t.sort,c=t.search,p=0,m=o.length;m>p;p+=1){switch(u=o[p],s=u.attr,f=u.eop,l=u.iop,v=u.sort,h=u.cust,d=u.vals,g=r.facet(s,f),v.by){case"count":g.sortByCount();break;case"activeCount":g.sortByActiveCount();break;default:g.sortByValue()}if(g[v.direction](),h)for(y in h)h.hasOwnProperty(y)&&g.customData(y,h[y]);for(O=0,b=d.length;b>O;O+=1)g.value(d[O],l)}if(a){var C=a.by,w=a.dir;C&&i(n).sortBy(C),w&&i(n)[w]()}return this.trigger("initFromSettingsJSON"),this},this.settingsJSON=function(){var e,n,r,o,a;if(e={},i&&d&&(e.sort={by:i,dir:d}),0!==t.size(s)){e.facets=[];for(n in s)if(s.hasOwnProperty(n)){r=s[n].facet.toJSON(),o=t.pluck(r.values,"active"),a=[];for(var c=0,u=o.length;u>c;c+=1)o[c]&&a.push(r.values[c].value);e.facets.push({attr:r.data.name,eop:r.data.extOperator,iop:r.data.intOperator,sort:r.data.sort,cust:r.data.customData,vals:a})}}return e},p(),v.on("removeFacet",O,this),v.on("value",b,this),v.on("removeValue clear",C,this),n.on("reset",N),n.on("add",x),n.on("remove",S),n.on("change",M)};return e.Facetr});