// Backbone.Facetr 0.2.0 
// Copyright (c)2012-2013 Arillo GmbH 
// Author Francesco Macri 
// Distributed under MIT license 
// https://github.com/arillo/Backbone.Facetr 
(function(e,t){if("object"==typeof exports){var r=require("underscore"),n=require("backbone");module.exports=t(r,n)}else"function"==typeof define&&define.amd?define(["underscore","backbone"],t):t(e,_,Backbone)})(this,function(e,t,r,n){"use strict";r.Facetr=function(e,t){return e instanceof r.Collection?a(e,t):o(e)},r.Facetr.VERSION="0.2.0";var i={},o=function(e){var t=i[e];return t?t:n},a=function(e,t){var r=e.facetrid||t||"fctr"+(new Date).getTime()+Math.floor(99*Math.random()+1),n=o(r);return n?n:(e.facetrid=r,i[r]=new s(e))},c=function(e,t){var i,o=t.split("."),a=o.length,c=0;do i=i instanceof Array?i:i&&(i.get&&i.get(o[c])||i[o[c]])||e&&e instanceof r.Model&&e.get(o[c])||n,c+=1;while(a>c);return i},u=function(e,i,o,a){t.extend(this,r.Events);var u=this,s=e,f=e,l="value",v="asc",h=[],d=[],g=[],p={},O=a,y="or",m=!1,C={},w=function(e,n,i){var o=n||"undefined",a=!1;if(o instanceof Object){var c=s.split(".")[1];o=c&&(o instanceof r.Model&&o.get(c)||o[c])||"undefined",a=!0}var u=t.find(e,function(e){return e.value===o});if(u)u.count=u.count+1,u.activeCount=u.activeCount+1;else{var f=t.sortedIndex(t.pluck(h,"value"),o);h.splice(f,0,{value:o,count:1,activeCount:1,active:!1}),p[o]=[]}a&&p[o].push(i)},b=function(e){var r=c(e,s);if(r)if(r instanceof Array)t.each(r,function(t){w(h,t,e.cid),p[t]&&p[t].push(e.cid)});else{if("object"==typeof r)throw u.remove(),Error("Model property can only be a value (string,number) or Array of values, not an object");w(h,r),p[r].push(e.cid)}},x=function(e){t(e).each(function(e){b(e)})},N=function(){h.sort(function(e,t){return"value"===l?"asc"===v?(e.value>t.value)-(e.value<t.value):(e.value<t.value)-(e.value>t.value):"activeCount"===l?"asc"===v?e.activeCount<t.activeCount?-1:e.activeCount>t.activeCount?1:(e.value>t.value)-(e.value<t.value):e.activeCount<t.activeCount?1:e.activeCount>t.activeCount?-1:(e.value<t.value)-(e.value>t.value):"asc"===v?e.count<t.count?-1:e.count>t.count?1:(e.value>t.value)-(e.value<t.value):e.count<t.count?1:e.count>t.count?-1:(e.value<t.value)-(e.value>t.value)})},M=function(){return 0!==d.length},F=function(e){for(var r=0,n=h.length;n>r;r+=1){var i=t.intersection(p[h[r].value],e).length;h[r].activeCount=0!==i?i:0}},P=function(e){var t=d.splice(0,d.length);h.splice(0,h.length),g.splice(0,g.length),p={},x(e);for(var r=0,n=t.length;n>r;r+=1)u.value(t[r])},S=function(e){b(e);for(var t=0,r=d.length;r>t;t+=1)u.value(d[t])},V=function(e){var r,n,i=e.cid,o=(e.toJSON(),function(e){for(r=h.length-1;-1!==r;){var n=h[r];if(n.value===e){if(n.count-=1,n.activeCount-=1,0===n.count){h.splice(r,1);var i=t.indexOf(d,n.value);-1!==i&&(d.splice(i,1),m=M())}break}r-=1}});for(var a in p)p.hasOwnProperty(a)&&(r=t.indexOf(p[a],i),-1!==r&&p[a].splice(r,1));if(n=c(e,s))if(n instanceof Array)for(var u=0,f=n.length;f>u;u++)o(n[u]);else o(n);r=t.indexOf(g,i),-1!==r&&g.splice(r,1)},k=function(e){var t,n;c(new r.Model(e.changedAttributes()),s)&&(t=new r.Model(e.previousAttributes()),n=c(t,s),t.cid=e.cid,V(t),S(e))},J=function(){this.and=function(e){return y="and",u.value(e),this},this.or=function(e){return y="or",u.value(e),this}};this.label=function(e){return f=e,this},this.asc=function(){return v="asc",N(),this},this.desc=function(){return v="desc",N(),this},this.sortByValue=function(){return l="value",N(),this},this.sortByCount=function(){return l="count",N(),this},this.sortByActiveCount=function(){return l="activeCount",N(),this},this.toJSON=function(){return{data:{name:s,label:f,extOperator:O,intOperator:y,sort:{by:l,direction:v},selected:m,customData:C},values:h}},this.remove=function(){o.off("resetCollection",F),o.off("resetOrigCollection",P),o.off("addModel",S),o.off("removeModel",V),o.off("changeModel",k),o.trigger("removeFacet",s)},this.value=function(e,r){r&&(y=r);var n,i=t.chain(h).pluck("value").indexOf(e).value();if(-1!==i)return n=h[i],n.active||(n.active=!0,d.push(n.value)),g="or"===y||0===g.length?t.union(g,p[e]):t.intersection(g,p[e]),m=M(),o.trigger("value",s,e,g),new J(this,y);throw Error('Value "'+e+'" does not exist for facet '+s)},this.removeValue=function(e){var r,n,i,a=t.chain(h).pluck("value").indexOf(e).value();if(-1!==a){if(r=h[a],r.active){if(r.active=!1,d.splice(t.indexOf(d,r.value),1),i=t.filter(p[e],function(e){for(var r in p)if(p.hasOwnProperty(r)&&-1!==t.indexOf(d,r)&&-1!==t.indexOf(p[r],e))return!1;return!0}),g=t.difference(g,i),"and"===y){n=[];for(var c=0,u=d.length;u>c;c+=1)n=0===n.length?t.union(n,p[d[c]]):t.intersection(n,p[d[c]]);g=t.union(g,n)}m=M(),o.trigger("removeValue",s,e,g)}return this}throw Error('Value "'+e+'" does not exist for facet '+s)},this.clear=function(){for(;d.length>0;)this.removeValue(d[0])},this.customData=function(e,t){return t!==n?(C[e]=t,this):C[e]},x(i),o.on("resetCollection",F),o.on("resetCollection",N),o.on("resetOrigCollection",P),o.on("addModel",S),o.on("removeModel",V),o.on("changeModel",k)},s=function(e){t.extend(this,r.Events);var n,o,a=this,s={},f={},l={},v=t.extend({},r.Events),h={},d="asc",g=function(){for(var t in f)f.hasOwnProperty(t)&&delete f[t];e.each(function(e){var t=e.clone();t.cid=e.cid,f[e.cid]=t})},p=function(e){delete s[e]},O=function(e,t){var r=s[e];if(r&&r.operator===t)return r;var n=new u(e,f,v,t);return l[e]=[],{facet:n,operator:t}},y=function(e,t){l[e]=t,w()},m=function(e,t,r){y(e,r),this.trigger("filter",e,t)},C=function(e,t,r){y(e,r),this.trigger("unfilter",e,t)},w=function(r){var n=[],i=[];for(var o in f)f.hasOwnProperty(o)&&n.push(o);for(var c in l)l.hasOwnProperty(c)&&s[c].facet.toJSON().data.selected&&(n="or"===s[c].operator?t.union(n,l[c]):t.intersection(n,l[c]));for(var u in h)if(h.hasOwnProperty(u)){var d=h[u];d instanceof Function&&(n=t.filter(n,function(e){return d(f[e])}))}n.sort();for(var g=0,p=n.length;p>g;g+=1)i.push(f[n[g]]);e.reset(i,{silent:!0}),v.trigger("resetCollection",n),r||a.trigger("reset",i)},b=function(){g(),v.trigger("resetOrigCollection",f)},x=function(e){var t=e.clone();t.cid=e.cid,f[e.cid]=t,v.trigger("addModel",e),a.trigger("add",e)},N=function(e){delete f[e.cid],v.trigger("removeModel",e);var r=t.any(s,function(e){return e.facet.toJSON().data.selected});r||w(),a.trigger("remove",e)},M=function(e){delete f[e.cid];var r=e.clone();r.cid=e.cid,f[e.cid]=r,v.trigger("changeModel",e);var n=t.any(s,function(e){return e.facet.toJSON().data.selected});n||w(),a.trigger("change",e)},F=function(t){e.comparator=function(e,t){var r,i,o=c(e,n),a=c(t,n);if(isNaN(o)||isNaN(a)?(r=Date.parse(o),i=Date.parse(a),(isNaN(r)||isNaN(i))&&(r=o,i=a)):(r=parseFloat(o,10),i=parseFloat(a,10)),"asc"===d){if(r&&i)return(r>i)-(i>r);if(r)return 1;if(i)return-1}else{if(r&&i)return(i>r)-(r>i);if(r)return-1;if(i)return 1}},e.sort(),t||a.trigger("sort",n,d)};this.facet=function(e,t){var r=!t||"and"!==t&&"or"!==t?"and":t;return s[e]=O(e,r),this.trigger("facet",e),s[e].facet},this.toJSON=function(){var e,r,n,i,a=[],c=[];for(e in s)s.hasOwnProperty(e)&&(r=s[e],n=r.facet.toJSON(),n.data.operator=r.operator,o&&o instanceof Array?(i=t.indexOf(o,n.data.name),-1!==i?c[i]=n:a.push(n)):a.push(n));return c.concat(a)},this.clear=function(t){var r;for(r in s)s.hasOwnProperty(r)&&(s[r].facet.remove(),delete s[r]);var n=[];for(r in f)f.hasOwnProperty(r)&&n.push(f[r]);return e.reset(n,{silent:!0}),t||this.trigger("clear",n),l={},this},this.clearValues=function(t){var r;for(r in s)s.hasOwnProperty(r)&&s[r].facet.clear();var n=[];for(r in f)f.hasOwnProperty(r)&&n.push(f[r]);return e.reset(n,{silent:!0}),t||this.trigger("clearValues",n),l={},this},this.remove=function(){var t=e.facetrid;this.clear(!0),e.off("reset",b),e.off("add",x),e.off("remove",N),e.off("change",M),delete e.facetrid,delete i[t]},this.facetsOrder=function(e){return o=e,this.trigger("facetsOrderChange",e),this},this.sortBy=function(e,t){return n=e,F(t),this},this.asc=function(e){return d="asc",F(e),this},this.desc=function(e){return d="desc",F(e),this},this.addFilter=function(e,t,r){return t&&e&&(h[e]=t,w(r)),this},this.removeFilter=function(e,t){return e&&(delete h[e],w(t)),this},this.clearFilters=function(e){for(var t in h)h.hasOwnProperty(t)&&delete h[t];return w(e),this},this.collection=function(){return e},this.origLength=function(){return t.size(f)},this.initFromSettingsJSON=function(t){var n=r.Facetr,i=t.facets,o=t.sort;t.search;for(var a=0,c=i.length;c>a;a+=1){var u,s=i[a],f=s.attr,l=s.eop,v=s.iop,o=s.sort,h=s.vals;switch(u=n(e).facet(f,l),o.by){case"count":u.sortByCount();break;case"activeCount":u.sortByActiveCount();break;default:u.sortByValue()}if(u[o.direction](),u)for(var d=0,g=h.length;g>d;d+=1)u.value(h[d],v)}if(o){var p=o.by,O=o.dir;p&&n(e).sortBy(p,!0),O&&n(e)[O](!0)}return this.trigger("reset"),this},this.settingsJSON=function(){var e={};if(n&&d&&(e.sort={by:n,dir:d}),0!==t.size(s)){e.facets=[];for(var r in s)if(s.hasOwnProperty(r)){for(var i=s[r].facet.toJSON(),o=t.pluck(i.values,"active"),a=[],c=0,u=o.length;u>c;c+=1)o[c]&&a.push(i.values[c].value);e.facets.push({attr:i.data.name,eop:i.data.extOperator,iop:i.data.intOperator,sort:i.data.sort,vals:a})}}return e},g(),v.on("removeFacet",p,this),v.on("value",m,this),v.on("removeValue clear",C,this),e.on("reset",b),e.on("add",x),e.on("remove",N),e.on("change",M)};return e.Facetr=r.Facetr});