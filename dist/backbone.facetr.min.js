// backbone.facetr 0.3.8 
// Copyright (c)2012 Arillo GmbH 
// Author: Francesco Macri 
// Distributed under MIT license 
// https://github.com/arillo/Backbone.Facetr 
(function(e,t){if("object"==typeof exports){var n=require("underscore"),r=require("backbone");module.exports=t(n,r)}else"function"==typeof define&&define.amd?define(["underscore","backbone"],t):e.Facetr=t(_,Backbone)})(this,function(e,t,n){"use strict";t.Facetr=function(e,n){return e instanceof t.Collection?o(e,n):i(e)},t.Facetr.VERSION="0.3.8";var r={},i=function(e){var t=r[e];return t?t:n},o=function(e,t){var n=e.facetrid||t||"fctr"+(new Date).getTime()+Math.floor(99*Math.random()+1),o=i(n);return o?o:(e.facetrid=n,r[n]=new c(e))},a=function(e,r){var i,o=r.split("."),a=o.length,u=0;for(i=e.get(o[u]),u=1;a>u;u+=1){if(i===n)return i;if(i instanceof Array)return i;i=i instanceof t.Model?i.get(o[u]):"[object Object]"===Object.prototype.toString.call(i)?i[o[u]]:i}return i},u=function(r,i,o,u){e.extend(this,t.Events);var c=this,s=r,l=r,f="value",v="asc",h=[],d=[],g=[],p={},y=u,O="or",m=!1,C={},b=!1,w=[],x=[],M={},N={},S=function(r,i,o){var a=i!==n&&null!==i?i:"undefined",u=!1;if(null!=typeof a&&"object"==typeof a){var c=s.split(".")[1];a=c&&(a instanceof t.Model&&a.get(c)||a[c])||"undefined",u=!0}var l=e.find(r,function(e){return e.value===a});if(l)l.count=l.count+1,l.activeCount=l.activeCount+1;else{var f=e.sortedIndex(e.pluck(h,"value"),a);h.splice(f,0,{value:a,count:1,activeCount:1,active:!1}),p[a]=[]}return u&&p[a].push(o),a},F=function(t){var n,r=a(t,s);if(r instanceof Array)0===r.length?(n=S(h,"undefined",t.cid),p[n].push(t.cid)):e.each(r,function(e){n=S(h,e,t.cid),p[n]&&p[n].push(t.cid)});else{if(null!=r&&"object"==typeof r)throw c.remove(),Error("Model property can only be a value (string,number,boolean) or Array of values, not an object");n=S(h,r),p[n].push(t.cid)}},P=function(t){e(t).each(function(e){F(e)})},j=function(e,t){return"value"===f?"asc"===v?(e.value>t.value)-(e.value<t.value):(e.value<t.value)-(e.value>t.value):"activeCount"===f?"asc"===v?e.activeCount<t.activeCount?-1:e.activeCount>t.activeCount?1:(e.value>t.value)-(e.value<t.value):e.activeCount<t.activeCount?1:e.activeCount>t.activeCount?-1:(e.value<t.value)-(e.value>t.value):"asc"===v?e.count<t.count?-1:e.count>t.count?1:(e.value>t.value)-(e.value<t.value):e.count<t.count?1:e.count>t.count?-1:(e.value<t.value)-(e.value>t.value)},k=function(){h.sort(j),b&&x.sort(j)},A=function(){return 0!==d.length},V=function(t){for(var n=0,r=h.length;r>n;n+=1){var i=e.intersection(p[h[n].value],t).length;h[n].activeCount=0!==i?i:0}},J=function(e){var t=d.splice(0,d.length);h.splice(0,h.length),g.splice(0,g.length),p={},P(e);for(var n=0,r=t.length;r>n;n+=1)c.value(t[n])},B=function(e){F(e);for(var t=0,n=d.length;n>t;t+=1)c.value(d[t])},D=function(t){var n,r,i=t.cid,o=function(t){for(n=h.length-1;-1!==n;){var r=h[n];if(r.value===t){if(r.count-=1,r.activeCount-=1,0===r.count){h.splice(n,1);var i=e.indexOf(d,r.value);-1!==i&&(d.splice(i,1),m=A())}break}n-=1}};for(var u in p)p.hasOwnProperty(u)&&(n=e.indexOf(p[u],i),-1!==n&&p[u].splice(n,1));if(r=a(t,s))if(r instanceof Array)for(var c=0,l=r.length;l>c;c++)o(r[c]);else o(r);n=e.indexOf(g,i),-1!==n&&g.splice(n,1)},E=function(e){var n,r;a(new t.Model(e.changedAttributes()),s)&&(n=new t.Model(e.previousAttributes()),r=a(n,s),n.cid=e.cid,D(n),B(e))},q=function(t){var n,r;null==M[t.value]&&(M[t.value]=[]),n=[],r=function(i){i.value!==t.value&&n.push(i.value),i.groups&&e.each(i.groups,r)},r(t),M[t.value]=e.union(M[t.value],n)},z=function(t){var r=function(t,n,i){null==N[i.value]&&(N[i.value]=[]),n&&(t.push(n.value),N[i.value]=e.union(N[i.value],t)),i.groups&&e.each(i.groups,function(e){return r(t,i,e)})};r([],n,t)},I=function(t){var n,r,i,o,a;if(o=t.groups,i={value:t.value,label:t.label,active:!1,activeCount:0,count:0},a=e.find(h,function(e){return e.value===i.value}),a&&e.extend(i,a),o&&"[object Array]"===Object.prototype.toString.call(o)&&(r=o.length)>0){for(i.groups=[],n=0;r>n;n+=1)i.groups.push(I(o[n]));i.activeCount=e.reduce(i.groups,function(e,t){return e+t.activeCount},i.activeCount),i.count=e.reduce(i.groups,function(e,t){return e+t.count},i.count)}return q(i),i},L=function(){var e,t;for(x.length=0,e=0,t=w.length;t>e;e+=1)x.push(I(w[e])),z(w[e]);x.sort(j)},R=function(){this.and=function(e,t){return O="and",c.value(e,t),this},this.or=function(e,t){return O="or",c.value(e,t),this}};this.label=function(e){return l=e,this},this.asc=function(){return v="asc",k(),this},this.desc=function(){return v="desc",k(),this},this.sortByValue=function(){return f="value",k(),this},this.sortByCount=function(){return f="count",k(),this},this.sortByActiveCount=function(){return f="activeCount",k(),this},this.toJSON=function(){var e;return e={data:{name:s,hierarchical:b,label:l,extOperator:y,intOperator:O,sort:{by:f,direction:v},selected:m,customData:C},values:h},b&&(e.groupedValues=x),e},this.remove=function(){o.off("resetCollection",V),o.off("resetOrigCollection",J),o.off("addModel",B),o.off("removeModel",D),o.off("changeModel",E),o.trigger("removeFacet",s)},this.value=function(t,n,r){var i,a,u,c,l,f;if(n&&(O=n),c=e.chain(h).pluck("value").indexOf(t).value(),-1!==c){if(l=h[c],l.active||(l.active=!0,d.push(l.value)),u="or"===O||0===g.length?e.union:e.intersection,g=u(g,p[t]),b&&null!=M[l.value]&&(f=M[l.value]).length>0)for(d.concat(f),i=0,a=f.length;a>i;i+=1)g=u(g,p[f[i]])}else-1===d.indexOf(t)&&(d.push(t),"and"===O&&(g=[]));return m=A(),o.trigger("value",s,t,g,r),r||this.trigger("value",t),new R(this,O)},this.removeValue=function(t,n){var r,i,a,u=e.chain(h).pluck("value").indexOf(t).value();if(-1!==u&&(r=h[u],r.active=!1),d.splice(e.indexOf(d,r&&r.value||t),1),a=e.filter(p[t],function(t){for(var n in p)if(p.hasOwnProperty(n)&&-1!==e.indexOf(d,n)&&-1!==e.indexOf(p[n],t))return!1;return!0}),g=e.difference(g,a),"and"===O){i=[];for(var c=0,l=d.length;l>c;c+=1)i=0===i.length?e.union(i,p[d[c]]):e.intersection(i,p[d[c]]);g=e.union(g,i)}if(b&&null!=N[t]){var f=e.intersection(N[t],d);f.length>0&&(g=e.union(g,p[t]))}return m=A(),o.trigger("removeValue",s,t,g,n),n||this.trigger("removeValue",t),this},this.clear=function(e){for(;d.length>0;)this.removeValue(d[0],!0);return e||this.trigger("clear"),this},this.customData=function(e,t){return t!==n?(C[e]=t,this):C[e]},this.isSelected=function(){return m},this.hierarchy=function(e){if("[object Array]"!==Object.prototype.toString.call(e))throw Error("Facet.hierarchy: wrong settings object. Check the documentation for the right format");return w=e,b=!0,L(),o.on("resetCollection addModel removeModel changeModel",L),this.trigger("hierarchy",w),this},P(i),o.on("resetCollection",V),o.on("resetCollection",k),o.on("resetOrigCollection",J),o.on("addModel",B),o.on("removeModel",D),o.on("changeModel",E)},c=function(n){e.extend(this,t.Events);var i,o,c=this,s={},l={},f={},v=e.extend({},t.Events),h={},d="asc",g=!1,p=function(){for(var e in l)l.hasOwnProperty(e)&&delete l[e];n.each(function(e){var t=e.clone();t.cid=e.cid,l[e.cid]=t})},y=function(e){delete s[e],delete f[e],w()},O=function(e,t){var n=s[e];if(n&&n.operator===t)return n;var r=new u(e,l,v,t);return f[e]=[],{facet:r,operator:t}},m=function(e,t){f[e]=t,w()},C=function(e,t,n,r){m(e,n),r!==!0&&this.trigger("filter",e,t)},b=function(e,t,n,r){m(e,n),r!==!0&&this.trigger("unfilter",e,t)},w=function(){var t,r,i,o,a=[],u=[];for(t in l)l.hasOwnProperty(t)&&a.push(t);for(r in f)f.hasOwnProperty(r)&&s[r].facet.toJSON().data.selected&&(a="or"===s[r].operator?e.union(a,f[r]):e.intersection(a,f[r]));o=function(e){return c(l[e])};for(i in h)if(h.hasOwnProperty(i)){var c=h[i];c instanceof Function&&(a=e.filter(a,o))}a.sort();for(var d=0,p=a.length;p>d;d+=1)u.push(l[a[d]]);v.trigger("resetCollection",a),g=!0,n.reset(u),g=!1},x=function(){g||(p(),v.trigger("resetOrigCollection",l))},M=function(e){var t=e.clone();t.cid=e.cid,l[e.cid]=t,v.trigger("addModel",e)},N=function(t){delete l[t.cid],v.trigger("removeModel",t);var n=e.any(s,function(e){return e.facet.toJSON().data.selected});n||w()},S=function(t){delete l[t.cid];var n=t.clone();n.cid=t.cid,l[t.cid]=n,v.trigger("changeModel",t);var r=e.any(s,function(e){return e.facet.toJSON().data.selected});r||w()},F=function(e){n.comparator=function(e,t){var n,r,o=a(e,i),u=a(t,i);if(isNaN(o)||isNaN(u)?(n=Date.parse(o),r=Date.parse(u),(isNaN(n)||isNaN(r))&&(n=o,r=u)):(n=parseFloat(o,10),r=parseFloat(u,10)),"asc"===d){if(n&&r)return(n>r)-(r>n);if(n)return 1;if(r)return-1}else{if(n&&r)return(r>n)-(n>r);if(n)return-1;if(r)return 1}},n.sort(),e!==!0&&c.trigger("sort",i,d)};this.facet=function(e,t,n){var r=!t||"and"!==t&&"or"!==t?"and":t;return s[e]=O(e,r),n!==!0&&this.trigger("facet",e),s[e].facet},this.toJSON=function(){var t,n,r,i,a=[],u=[];for(t in s)s.hasOwnProperty(t)&&(n=s[t],r=n.facet.toJSON(),r.data.operator=n.operator,o&&o instanceof Array?(i=e.indexOf(o,r.data.name),-1!==i?u[i]=r:a.push(r)):a.push(r));return u.concat(a)},this.clear=function(e){var t;for(t in s)s.hasOwnProperty(t)&&(s[t].facet.remove(),delete s[t]);var r=[];for(t in l)l.hasOwnProperty(t)&&r.push(l[t]);return n.reset(r),f={},e!==!0&&this.trigger("clear"),this},this.clearValues=function(e){var t;for(t in s)s.hasOwnProperty(t)&&s[t].facet.clear();var r=[];for(t in l)l.hasOwnProperty(t)&&r.push(l[t]);return n.reset(r),f={},e!==!0&&this.trigger("clearValues"),this},this.remove=function(){var e=n.facetrid;this.clear(!0),n.off("reset",x),n.off("add",M),n.off("remove",N),n.off("change",S),delete n.facetrid,delete r[e]},this.facetsOrder=function(e,t){return o=e,t!==!0&&this.trigger("facetsOrderChange",e),this},this.sortBy=function(e,t){return i=e,F(t),this},this.asc=function(e){return d="asc",F(e),this},this.desc=function(e){return d="desc",F(e),this},this.addFilter=function(e,t,n){return t&&e&&(h[e]=t,w(n)),this},this.removeFilter=function(e,t){return e&&(delete h[e],w(t)),this},this.clearFilters=function(e){for(var t in h)h.hasOwnProperty(t)&&delete h[t];return w(e),this},this.collection=function(){return n},this.origLength=function(){return e.size(l)},this.facets=function(){return e.pluck(s,"facet")},this.initFromSettingsJSON=function(e){var r,i,o,a,u,c,s,l,f,v,h,d,g,p,y,O,m,C;for(i=t.Facetr,r=i(n),o=e.facets,a=e.sort,u=e.search,p=0,m=o.length;m>p;p+=1){switch(c=o[p],s=c.attr,l=c.eop,f=c.iop,v=c.sort,h=c.cust,d=c.vals,g=r.facet(s,l),v.by){case"count":g.sortByCount();break;case"activeCount":g.sortByActiveCount();break;default:g.sortByValue()}if(g[v.direction](),h)for(O in h)h.hasOwnProperty(O)&&g.customData(O,h[O]);for(y=0,C=d.length;C>y;y+=1)g.value(d[y],f)}if(a){var b=a.by,w=a.dir;b&&i(n).sortBy(b),w&&i(n)[w]()}return this.trigger("initFromSettingsJSON"),this},this.settingsJSON=function(){var t,n,r,o,a;if(t={},i&&d&&(t.sort={by:i,dir:d}),0!==e.size(s)){t.facets=[];for(n in s)if(s.hasOwnProperty(n)){r=s[n].facet.toJSON(),o=e.pluck(r.values,"active"),a=[];for(var u=0,c=o.length;c>u;u+=1)o[u]&&a.push(r.values[u].value);t.facets.push({attr:r.data.name,eop:r.data.extOperator,iop:r.data.intOperator,sort:r.data.sort,cust:r.data.customData,vals:a})}}return t},p(),v.on("removeFacet",y,this),v.on("value",C,this),v.on("removeValue clear",b,this),n.on("reset",x),n.on("add",M),n.on("remove",N),n.on("change",S)};return t.Facetr});